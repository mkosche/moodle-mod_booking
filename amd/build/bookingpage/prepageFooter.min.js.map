{"version":3,"file":"prepageFooter.min.js","sources":["../../src/bookingpage/prepageFooter.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     mod_booking/bookingpage/prepageFooter\n * @copyright  Wunderbyte GmbH <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport jQuery from 'jquery';\nimport {continueToNextPage, backToPreviousPage, setBackModalVariables} from 'mod_booking/bookit';\nimport {reloadAllTables} from 'local_wunderbyte_table/reload';\n\nvar SELECTORS = {\n    MODALID: 'sbPrePageModal_',\n    INLINEID: 'sbPrePageInline_',\n    INMODALDIV: ' div.modalMainContent',\n    INMODALFOOTER: ' div.prepage-booking-footer',\n    INMODALBUTTON: 'div.in-modal-button',\n    BOOKITBUTTON: 'div.booking-button-area',\n    STATICBACKDROP: 'div.modal-backdrop',\n};\n\n/* Const WAITTIME = 1500;*/\n\n/**\n * Add the click listener to a prepage modal button.\n * @param {integer} optionid\n * @param {integer} userid\n */\nexport function initFooterButtons(optionid, userid) {\n\n    // Everytime we close the modal, we want to reset to the first prepage.\n    jQuery.each(jQuery(\"[id^=\" + SELECTORS.MODALID + optionid + \"]\"), function() {\n        jQuery(this).on(\"hide.bs.modal\", function() {\n            setBackModalVariables(optionid);\n        });\n    });\n\n    initBookingButton(optionid);\n\n    // First, get all link elements in the footer.\n    let elements = document.querySelectorAll(\"[id^=\" + SELECTORS.MODALID + optionid + \"] \" + SELECTORS.INMODALFOOTER + \" a\");\n\n    if (elements.length === 0) {\n        elements = document.querySelectorAll(\"[id^=\" + SELECTORS.INLINEID + optionid + \"] \" + SELECTORS.INMODALFOOTER + \" a\");\n    }\n\n    // eslint-disable-next-line no-console\n    console.log('elements', elements, \"[id^=\" + SELECTORS.INLINEID + optionid + \"] \" + SELECTORS.INMODALFOOTER + \" a\");\n\n    elements.forEach(element => {\n        if (element && !element.dataset.initialized) {\n\n            // Make sure we dont initialize this twice.\n            element.dataset.initialized = true;\n\n            const action = element.dataset.action;\n\n            // We might to execute some actions right away.\n\n            switch (action) {\n                // If we find the checkout button, we reload shopping cart.\n                case 'closeinline':\n                case 'continuepost':\n                case 'checkout':\n\n                    // eslint-disable-next-line no-console\n                    console.log('closeinline');\n\n                    import('local_shopping_cart/cart').then(cart => {\n\n                        const oncashier = window.location.href.indexOf(\"cashier.php\");\n\n                        // If we are not on cashier, we can just redirect.\n                        if (oncashier > 0) {\n                            cart.reinit(-1);\n                        } else {\n                            cart.reinit();\n                        }\n\n                        return;\n                    }).catch(e => {\n                        // eslint-disable-next-line no-console\n                        console.log(e);\n                    });\n\n                    listenToCloseInline();\n                break;\n            }\n\n            // Depending on the action button, we add the right listener.\n            element.addEventListener('click', () => {\n\n                if (element.classList.contains('hidden')) {\n                    return;\n                }\n\n                // The logic might be blocked because eg a form is there to prevent it.\n                if (element.dataset.blocked == 'true') {\n                    return;\n                }\n\n                switch (action) {\n                    case 'back':\n                        backToPreviousPage(optionid, userid);\n                    break;\n                    case 'continue':\n                    case 'continuepost':\n                        continueToNextPage(optionid, userid);\n                    break;\n                    case 'checkout':\n                        closeModal(optionid);\n                        window.location.href = element.dataset.href;\n                    break;\n                    case 'closemodal':\n                        closeModal(optionid);\n                    break;\n                    case 'closeinline':\n                        closeInline(optionid);\n\n                }\n            });\n        }\n    });\n}\n\n/**\n *\n * @param {int} optionid\n */\nasync function initBookingButton(optionid) {\n\n    // First, we get the right modal.\n    let modal = document.querySelector(\"div.modal.show[id^=\" + SELECTORS.MODALID + optionid + \"]\");\n\n    if (!modal) {\n\n        // First, we get the right modal.\n        const modals = document.querySelectorAll(\"div.inlineprepagearea [id^=\" + SELECTORS.INLINEID + optionid + \"]\");\n\n        modals.forEach(el => {\n            if (!isHidden(el)) {\n                modal = el;\n            }\n        });\n        if (!modal) {\n            return;\n        }\n    }\n\n    modal.addEventListener('click', (e) => {\n\n        let button = e.target;\n\n        if (button) {\n\n            const bookingButtonArea = e.target.closest(SELECTORS.BOOKITBUTTON);\n\n            button = e.target.closest('.btn');\n\n            if (bookingButtonArea && button) {\n\n                if ((bookingButtonArea.dataset.action == 'noforward')) {\n                    return;\n                }\n\n                // There are several bugs caused by automatic forwarding, so we comment it out for now.\n                // We don't continue right away but wait for a second.\n                /* setTimeout(() => {\n                    continueToNextPage(optionid);\n                }, WAITTIME);*/\n            }\n        }\n    });\n}\n\n/**\n *\n * @param {int} optionid\n */\nexport function closeModal(optionid) {\n\n    jQuery.each(jQuery(\"[id^=\" + SELECTORS.MODALID + optionid + \"]\"), function() {\n        jQuery(this).modal('hide');\n        reloadAllTables();\n    });\n}\n\n/**\n *\n * @param {int} optionid\n */\nexport function closeInline(optionid) {\n\n    jQuery.each(jQuery(\"[id^=\" + SELECTORS.INLINEID + optionid + \"]\"), function() {\n        jQuery(this).collapse('toggle');\n        reloadAllTables();\n    });\n}\n\n/**\n *\n * @param {int} optionid\n */\nfunction listenToCloseInline(optionid) {\n\n    jQuery.each(jQuery(\"[id^=\" + SELECTORS.INLINEID + optionid + \"]\"), function() {\n\n        jQuery(this).on('hide.bs.collapse', function() {\n\n            reloadAllTables();\n        });\n    });\n}\n\n/**\n * Function to check visibility of element.\n * @param {*} el\n * @returns {boolean}\n */\nfunction isHidden(el) {\n    var style = window.getComputedStyle(el);\n    return ((style.display === 'none') || (style.visibility === 'hidden'));\n}"],"names":["optionid","userid","each","SELECTORS","this","on","modal","document","querySelector","querySelectorAll","forEach","el","style","window","getComputedStyle","display","visibility","isHidden","addEventListener","e","button","target","bookingButtonArea","closest","dataset","action","initBookingButton","elements","length","console","log","element","initialized","then","cart","location","href","indexOf","reinit","catch","listenToCloseInline","classList","contains","blocked","closeModal","closeInline","collapse"],"mappings":"yUAyCkCA,SAAUC,wBAGjCC,MAAK,mBAAO,QAAUC,kBAAoBH,SAAW,MAAM,+BACvDI,MAAMC,GAAG,iBAAiB,6CACPL,+BAgGDA,cAGzBM,MAAQC,SAASC,cAAc,sBAAwBL,kBAAoBH,SAAW,SAErFM,MAAO,IAGOC,SAASE,iBAAiB,8BAAgCN,mBAAqBH,SAAW,KAElGU,SAAQC,eAgFLA,QACVC,MAAQC,OAAOC,iBAAiBH,UACT,SAAlBC,MAAMG,SAA6C,WAArBH,MAAMI,YAjFhCC,CAASN,MACVL,MAAQK,QAGXL,aAKTA,MAAMY,iBAAiB,SAAUC,QAEzBC,OAASD,EAAEE,UAEXD,OAAQ,OAEFE,kBAAoBH,EAAEE,OAAOE,QAAQpB,2BAE3CiB,OAASD,EAAEE,OAAOE,QAAQ,QAEtBD,mBAAqBF,QAEoB,aAApCE,kBAAkBE,QAAQC,kBA5H3CC,CAAkB1B,cAGd2B,SAAWpB,SAASE,iBAAiB,QAAUN,kBAAoBH,SAAW,KAAOG,wBAA0B,MAE3F,IAApBwB,SAASC,SACTD,SAAWpB,SAASE,iBAAiB,QAAUN,mBAAqBH,SAAW,KAAOG,wBAA0B,OAIpH0B,QAAQC,IAAI,WAAYH,SAAU,QAAUxB,mBAAqBH,SAAW,KAAOG,wBAA0B,MAE7GwB,SAASjB,SAAQqB,aACTA,UAAYA,QAAQP,QAAQQ,YAAa,CAGzCD,QAAQP,QAAQQ,aAAc,QAExBP,OAASM,QAAQP,QAAQC,cAIvBA,YAEC,kBACA,mBACA,WAGDI,QAAQC,IAAI,0oBAEuBG,MAAKC,OAElBrB,OAAOsB,SAASC,KAAKC,QAAQ,eAG/B,EACZH,KAAKI,QAAQ,GAEbJ,KAAKI,YAIVC,OAAMpB,IAELU,QAAQC,IAAIX,eAyHPnB,0BAElBE,MAAK,mBAAO,QAAUC,mBAAqBH,SAAW,MAAM,+BAExDI,MAAMC,GAAG,oBAAoB,+CA1HxBmC,GAKRT,QAAQb,iBAAiB,SAAS,SAE1Ba,QAAQU,UAAUC,SAAS,WAKA,QAA3BX,QAAQP,QAAQmB,eAIZlB,YACC,sCACkBzB,SAAUC,kBAE5B,eACA,8CACkBD,SAAUC,kBAE5B,WACD2C,WAAW5C,UACXa,OAAOsB,SAASC,KAAOL,QAAQP,QAAQY,eAEtC,aACDQ,WAAW5C,oBAEV,cACD6C,YAAY7C,iOA1GhCG,kBACS,kBADTA,mBAEU,mBAFVA,wBAIe,8BAJfA,uBAMc,mCAkKFyC,WAAW5C,0BAEhBE,MAAK,mBAAO,QAAUC,kBAAoBH,SAAW,MAAM,+BACvDI,MAAME,MAAM,kDASXuC,YAAY7C,0BAEjBE,MAAK,mBAAO,QAAUC,mBAAqBH,SAAW,MAAM,+BACxDI,MAAM0C,SAAS"}